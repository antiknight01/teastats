<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>BlackTea Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
/* =========================
   RESET
========================= */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: Inter, system-ui, sans-serif;
}

body {
  background: #0e0e11;
  color: #eaeaf0;
  min-height: 100vh;
}

/* =========================
   LAYOUT
========================= */
header {
  padding: 16px 20px;
  background: #14141a;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid #222;
}

header h1 {
  font-size: 20px;
  font-weight: 700;
}

nav button {
  background: transparent;
  border: none;
  color: #aaa;
  font-size: 14px;
  margin-left: 12px;
  cursor: pointer;
}

nav button:hover {
  color: #fff;
}

#app {
  padding: 20px;
  max-width: 1100px;
  margin: auto;
}

/* =========================
   COMMON
========================= */
.section {
  margin-bottom: 30px;
}

.section h2 {
  font-size: 18px;
  margin-bottom: 12px;
}

.card {
  background: #15151c;
  border: 1px solid #24242c;
  border-radius: 10px;
  padding: 14px;
  margin-bottom: 10px;
  cursor: pointer;
}

.card:hover {
  background: #1b1b25;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
  gap: 12px;
}

.badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 6px;
  font-size: 12px;
  background: #2a2a36;
  margin-left: 6px;
}

.win { color: #4ade80; }
.loss { color: #f87171; }

/* =========================
   SEARCH
========================= */
.search-box {
  margin-bottom: 20px;
}

.search-box input {
  width: 100%;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #333;
  background: #0f0f14;
  color: #fff;
  font-size: 14px;
}

/* =========================
   MATCH
========================= */
.player-row {
  display: flex;
  justify-content: space-between;
  padding: 6px 0;
  border-bottom: 1px solid #222;
}

.player-row:last-child {
  border-bottom: none;
}

/* =========================
   LINKS
========================= */
a {
  color: inherit;
  text-decoration: none;
}
</style>
</head>

<body>

<header>
  <h1>☕ BlackTea Tracker</h1>
  <nav>
    <button onclick="goHome()">Home</button>
  </nav>
</header>

<div id="app"></div>

<script>
/* =========================
   CONFIG
========================= */
const API_BASE = "https://tracker-s9qq.onrender.com";

/* =========================
   ROUTER
========================= */
function route() {
  const hash = location.hash || "#/";
  const parts = hash.replace("#/", "").split("/");

  if (parts[0] === "player") {
    loadPlayer(decodeURIComponent(parts[1]));
  } else if (parts[0] === "match") {
    loadMatch(parts[1]);
  } else {
    loadHome();
  }
}

window.addEventListener("hashchange", route);
window.addEventListener("load", route);

function goHome() {
  location.hash = "#/";
}

/* =========================
   HOME
========================= */
async function loadHome() {
  const app = document.getElementById("app");
  app.innerHTML = "<p>Loading...</p>";

  const [homeRes, playersRes] = await Promise.all([
    fetch(API_BASE + "/").then(r => r.json()),
    fetch(API_BASE + "/players").then(r => r.json())
  ]);

  app.innerHTML = `
    <div class="section">
      <h2>Leaderboard</h2>
      <div class="grid" id="leaderboard"></div>
    </div>

    <div class="section">
      <h2>Recent Matches</h2>
      <div id="recent"></div>
    </div>

    <div class="section">
      <h2>Search Player</h2>
      <div class="search-box">
        <input id="searchInput" placeholder="Type a name..." />
      </div>
      <div id="searchResults"></div>
    </div>
  `;

  renderLeaderboard(playersRes);
  renderRecent(homeRes.recent_matches);
  setupSearch();
}

function renderLeaderboard(players) {
  const el = document.getElementById("leaderboard");
  el.innerHTML = "";

  players.forEach(p => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <strong>${p.name}</strong><br>
      Wins: ${p.wins} · Losses: ${p.losses}
    `;
    card.onclick = () => location.hash = "#/player/" + encodeURIComponent(p.name);
    el.appendChild(card);
  });
}

function renderRecent(matches) {
  const el = document.getElementById("recent");
  el.innerHTML = "";

  matches.forEach(m => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      <strong>${m.winner}</strong> won<br>
      Duration: ${Math.floor(m.duration_sec / 60)}m ${m.duration_sec % 60}s
    `;
    card.onclick = () => location.hash = "#/match/" + m.id;
    el.appendChild(card);
  });
}

/* =========================
   SEARCH
========================= */
function setupSearch() {
  const input = document.getElementById("searchInput");
  const out = document.getElementById("searchResults");

  input.addEventListener("input", async () => {
    const q = input.value.trim();
    if (!q) {
      out.innerHTML = "";
      return;
    }

    const res = await fetch(API_BASE + "/players?q=" + encodeURIComponent(q));
    const players = await res.json();

    out.innerHTML = "";
    players.forEach(p => {
      const card = document.createElement("div");
      card.className = "card";
      card.textContent = p.name;
      card.onclick = () => location.hash = "#/player/" + encodeURIComponent(p.name);
      out.appendChild(card);
    });
  });
}

/* =========================
   PLAYER
========================= */
async function loadPlayer(name) {
  const app = document.getElementById("app");
  app.innerHTML = "<p>Loading player...</p>";

  const res = await fetch(API_BASE + "/player/" + encodeURIComponent(name));
  const data = await res.json();

  if (data.error) {
    app.innerHTML = "<p>Player not found</p>";
    return;
  }

  const p = data.profile;

  app.innerHTML = `
    <div class="section">
      <h2>${p.display_name}</h2>
      <p>
        Games: ${p.games_played} · 
        Wins: <span class="win">${p.wins}</span> · 
        Losses: <span class="loss">${p.losses}</span>
      </p>
    </div>

    <div class="section">
      <h2>Match Timeline</h2>
      <div id="timeline"></div>
    </div>
  `;

  const tl = document.getElementById("timeline");
  data.timeline.forEach(t => {
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `
      ${t.result.toUpperCase()} · ${t.ago}
    `;
    card.onclick = () => location.hash = "#/match/" + t.match_id;
    tl.appendChild(card);
  });
}

/* =========================
   MATCH
========================= */
async function loadMatch(id) {
  const app = document.getElementById("app");
  app.innerHTML = "<p>Loading match...</p>";

  const res = await fetch(API_BASE + "/match/" + id);
  const m = await res.json();

  if (m.error) {
    app.innerHTML = "<p>Match not found</p>";
    return;
  }

  app.innerHTML = `
    <div class="section">
      <h2>Match ${m.id}</h2>
      <p>
        Winner: <strong>${m.winner}</strong><br>
        Duration: ${Math.floor(m.duration_sec / 60)}m ${m.duration_sec % 60}s
      </p>
    </div>

    <div class="section">
      <h2>Players</h2>
      <div id="players"></div>
    </div>
  `;

  const el = document.getElementById("players");
  m.players.forEach(pl => {
    const row = document.createElement("div");
    row.className = "card";
    row.innerHTML = `
      <strong>${pl.name}</strong>
      <span class="badge ${pl.result}">${pl.result}</span><br>
      Words: ${pl.word_count}
    `;
    el.appendChild(row);
  });
}
</script>

</body>
</html>
