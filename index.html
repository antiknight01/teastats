<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Game Stats</title>

<style>
/* =========================================================
   CANVAS & SYSTEM
   ========================================================= */
:root{
  --bg:#0b1020;
  --panel:#121833;
  --panel-2:#171f42;
  --border:#2a3470;

  --text:#f7f9ff;
  --muted:#aeb6df;
  --dim:#7e87b8;

  --accent:#6bb2ff;
  --win:#7fc4ff;
  --loss:#ff8b8b;

  --radius:16px;
  --radius-lg:22px;

  --shadow:0 12px 30px rgba(0,0,0,.35);
  --ease:280ms cubic-bezier(.22,.61,.36,1);
}

*{box-sizing:border-box}
html,body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;
}
a{text-decoration:none;color:inherit}

/* =========================================================
   HEADER
   ========================================================= */
header{
  position:sticky;top:0;z-index:10;
  background:#0b1020cc;
  backdrop-filter:blur(10px);
  border-bottom:1px solid var(--border);
}
.header-inner{
  max-width:1400px;
  margin:auto;
  padding:18px 22px;
  display:grid;
  grid-template-columns:auto 1fr auto;
  gap:20px;
  align-items:center;
}
.logo{
  font-size:22px;
  font-weight:900;
  cursor:pointer;
}
.logo:hover{color:var(--accent)}
.search input{
  width:100%;
  padding:14px 18px;
  border-radius:14px;
  border:1px solid var(--border);
  background:var(--panel);
  color:var(--text);
}
.recent-btn{
  padding:14px 22px;
  border-radius:999px;
  font-weight:900;
  background:var(--accent);
  color:#081427;
  cursor:pointer;
}

/* =========================================================
   MAIN
   ========================================================= */
main{
  max-width:1400px;
  margin:auto;
  padding:36px 22px 100px;
}

/* =========================================================
   GENERIC
   ========================================================= */
.back{
  color:var(--accent);
  font-weight:800;
  margin-bottom:20px;
  cursor:pointer;
  display:inline-block;
}
.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:var(--radius-lg);
  padding:28px;
  margin-bottom:28px;
}
.card-title{
  font-size:22px;
  font-weight:900;
  margin-bottom:18px;
}
.muted{color:var(--muted);font-size:13px}

/* =========================================================
   LEADERBOARD
   ========================================================= */
.lb-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:18px;
}
.lb-card{
  background:var(--panel-2);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:22px;
  cursor:pointer;
  transition:var(--ease);
}
.lb-card:hover{
  transform:translateY(-4px);
  box-shadow:var(--shadow);
}
.lb-name{font-size:18px;font-weight:900}
.lb-stats{
  margin-top:8px;
  display:flex;
  gap:14px;
  font-size:13px;
  color:var(--muted);
}

/* =========================================================
   ROWS (MATCHES)
   ========================================================= */
.row{
  display:grid;
  grid-template-columns:1fr auto auto;
  gap:16px;
  padding:18px;
  border:1px solid var(--border);
  border-radius:var(--radius);
  margin-bottom:14px;
  cursor:pointer;
}
.row:hover{background:#1a2350}

/* =========================================================
   BADGES
   ========================================================= */
.badge{
  padding:4px 12px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
}
.badge.win{background:#243c66;color:var(--win)}
.badge.loss{background:#4a2b2b;color:var(--loss)}

/* =========================================================
   PROFILE
   ========================================================= */
.player-hero{
  display:grid;
  grid-template-columns:1.2fr 2fr;
  gap:26px;
}
.stats{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:14px;
}
.stat{
  background:var(--panel-2);
  border-radius:var(--radius);
  padding:20px;
  text-align:center;
  cursor:pointer;
}
.stat:hover{background:#202a5f}
.stat-value{font-size:28px;font-weight:900}
.stat-label{font-size:12px;color:var(--muted)}

/* =========================================================
   WORD ANALYTICS
   ========================================================= */
.words{display:flex;flex-wrap:wrap;gap:8px}
.word{
  padding:6px 12px;
  border-radius:999px;
  background:#1d275a;
  font-size:12px;
}

/* =========================================================
   COMPARE
   ========================================================= */
.compare{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:24px;
}

/* =========================================================
   STATE
   ========================================================= */
.state{text-align:center;padding:80px;color:var(--muted)}

@media(max-width:900px){
  .player-hero,.compare{grid-template-columns:1fr}
  .stats{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>

<body>
<header>
  <div class="header-inner">
    <div class="logo" onclick="go('/')">Game Stats</div>
    <div class="search"><input id="search" placeholder="Search players…"></div>
    <div class="recent-btn" onclick="go('/recent')">Recent</div>
  </div>
</header>

<main id="app"></main>

<script>
const API="https://tracker-s9qq.onrender.com";
const app=document.getElementById("app");
const search=document.getElementById("search");

let t;
search.oninput=()=>{
  clearTimeout(t);
  const q=search.value.trim();
  if(!q)return;
  t=setTimeout(()=>go("/search?q="+encodeURIComponent(q)),300);
};

window.addEventListener("hashchange",router);
function go(p){location.hash="#"+p}
function loading(){app.innerHTML='<div class="state">Loading…</div>'}
async function j(u){const r=await fetch(u);if(!r.ok)throw 0;return r.json()}
function dur(s){return s<60?s+"s":(s/60).toFixed(1)+" min"}

/* ================= ROUTER ================= */
function router(){
  const h=location.hash.slice(1)||"/";
  const [p,q]=h.split("?");
  const qs=new URLSearchParams(q||"");
  if(p==="/")home();
  else if(p==="/recent")recent();
  else if(p==="/search")searchPlayers(qs.get("q"));
  else if(p==="/compare")compare(qs.get("A"),qs.get("B"));
  else if(p.startsWith("/player/"))player(decodeURIComponent(p.slice(8)),qs);
  else if(p.startsWith("/match/"))match(decodeURIComponent(p.slice(7)));
}

/* ================= HOME ================= */
async function home(){
  loading();
  const d=await j(API+"/");
  d.leaderboard.sort((a,b)=>b.wins-a.wins);
  app.innerHTML=`
    <div class="card">
      <div class="card-title">Leaderboard</div>
      <div class="lb-grid">
        ${d.leaderboard.map(p=>`
          <div class="lb-card" onclick="go('/player/${encodeURIComponent(p.display_name)}')">
            <div class="lb-name">${p.display_name}</div>
            <div class="lb-stats">
              <span>${p.wins}W</span>
              <span>${p.losses}L</span>
              <span>${p.games_played} games</span>
            </div>
          </div>`).join("")}
      </div>
    </div>`;
}

/* ================= RECENT ================= */
async function recent(){
  loading();
  const d=await j(API+"/");
  app.innerHTML=`
    <div class="back" onclick="history.back()">← Back</div>
    <div class="card">
      <div class="card-title">Recent Matches</div>
      ${d.recent_matches.map(m=>`
        <div class="row" onclick="go('/match/${m.id||m.match_id}')">
          <div><strong>${m.winner}</strong> won</div>
          <div class="muted">${dur(m.duration_sec||0)}</div>
          <div class="muted">View</div>
        </div>`).join("")}
    </div>`;
}

/* ================= PLAYER ================= */
async function player(name,qs){
  loading();
  const d=await j(API+"/player/"+encodeURIComponent(name));

  let words=[],seconds=0;
  let streak=0,maxWin=0,maxLoss=0;
  let cur=0,last=null;

  for(const id of d.profile.matches){
    const m=await j(API+"/match/"+id);
    seconds+=m.duration_sec;
    const pl=m.players.find(x=>x.name===d.profile.display_name);
    if(pl) words.push(...pl.words);
  }

  d.timeline.forEach(t=>{
    if(t.result===last) cur++;
    else cur=1;
    last=t.result;
    if(t.result==="win") maxWin=Math.max(maxWin,cur);
    if(t.result==="loss") maxLoss=Math.max(maxLoss,cur);
  });

  app.innerHTML=`
    <div class="back" onclick="history.back()">← Back</div>

    <div class="card">
      <div class="player-hero">
        <div>
          <div class="card-title">${d.profile.display_name}</div>
          <div class="muted">${d.profile.games_played} games · ${dur(seconds)}</div>
        </div>
        <div class="stats">
          <div class="stat"><div class="stat-value">${d.profile.wins}</div><div class="stat-label">Wins</div></div>
          <div class="stat"><div class="stat-value">${d.profile.losses}</div><div class="stat-label">Losses</div></div>
          <div class="stat" onclick="showWords()"><div class="stat-value">${words.length}</div><div class="stat-label">Words</div></div>
          <div class="stat"><div class="stat-value">${maxWin}</div><div class="stat-label">Best Win Streak</div></div>
          <div class="stat"><div class="stat-value">${maxLoss}</div><div class="stat-label">Worst Loss Streak</div></div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Recent Matches</div>
      ${d.timeline.map(t=>`
        <div class="row" onclick="go('/match/${t.match_id}')">
          <div>${t.result==="win"?"Victory":"Defeat"}</div>
          <span class="badge ${t.result}">${t.result}</span>
          <div class="muted">${t.ago}</div>
        </div>`).join("")}
    </div>

    <div class="card" id="words" style="display:none">
      <div class="card-title">Word Analytics</div>
      <div class="words">${words.map(w=>`<div class="word">${w}</div>`).join("")}</div>
    </div>`;
}

function showWords(){
  const w=document.getElementById("words");
  w.style.display="block";
  w.scrollIntoView({behavior:"smooth"});
}

/* ================= COMPARE ================= */
async function compare(a,b){
  loading();
  const A=await j(API+"/player/"+a);
  const B=await j(API+"/player/"+b);

  app.innerHTML=`
    <div class="back" onclick="history.back()">← Back</div>
    <div class="card">
      <div class="card-title">Comparison</div>
      <div class="compare">
        <div><strong>${A.profile.display_name}</strong><div>${A.profile.wins}W ${A.profile.losses}L</div></div>
        <div><strong>${B.profile.display_name}</strong><div>${B.profile.wins}W ${B.profile.losses}L</div></div>
      </div>
    </div>`;
}

/* ================= MATCH ================= */
async function match(id){
  loading();
  const m=await j(API+"/match/"+id);
  app.innerHTML=`
    <div class="back" onclick="history.back()">← Back</div>
    <div class="card">
      <div class="muted">Match ID ${m.id}</div>
      <div class="card-title">${m.winner} won</div>
      <div class="muted">${dur(m.duration_sec)}</div>
      ${m.players.map(p=>`
        <div style="margin-top:20px">
          <strong>${p.name}</strong>
          <span class="badge ${p.result}">${p.result}</span>
          <div class="words">${p.words.map(w=>`<div class="word">${w}</div>`).join("")}</div>
        </div>`).join("")}
    </div>`;
}

router();
</script>
</body>
</html>
